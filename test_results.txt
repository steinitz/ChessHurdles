
> tanstack-start-better-auth@1.0.0 test /Users/steinitz/Documents/Projects/Web/Chess/ChessHurdles/ChessHurdles
> vitest stzUser/test/unit/wallet.integration.test.ts


 RUN  v3.2.4 /Users/steinitz/Documents/Projects/Web/Chess/ChessHurdles/ChessHurdles

stdout | stzUser/test/unit/wallet.integration.test.ts
[dotenv@17.2.1] injecting env (12) from .env.test -- tip: âš™ï¸  override existing env vars with { override: true }

stdout | stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration
ğŸ Ensuring additional foundation tables...

stdout | stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration
âœ… Additional foundation tables are ready

stdout | stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should consume resources from daily grant
ğŸ Granting daily credits to user ax3tu8utmdzBmmivul4GHeCiTiTCUVQv

stdout | stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should consume from credits after grant is exhausted
ğŸ Granting daily credits to user GZIZOmjgKlbrZ8GaKFv5DXgpUyClKeb6

 â¯ stzUser/test/unit/wallet.integration.test.ts (8 tests | 8 failed) 764ms
   Ã— Wallet Ledger Integration > should start with 100 credits (from daily grant) 103ms
     â†’ database disk image is malformed
   Ã— Wallet Ledger Integration > should consume resources from daily grant 90ms
     â†’ database disk image is malformed
   Ã— Wallet Ledger Integration > should consume from credits after grant is exhausted 82ms
     â†’ database disk image is malformed
   Ã— Wallet Ledger Integration > should handle granting credits correctly 85ms
     â†’ database disk image is malformed
   Ã— Wallet Ledger Integration > should support consuming multiple credits at once 80ms
     â†’ database disk image is malformed
   Ã— Wallet Ledger Integration > should prevent double-granting during concurrent requests (Race Condition) 162ms
     â†’ database disk image is malformed
   Ã— Wallet Ledger Integration > should prevent negative balance during concurrent consumption 84ms
     â†’ database disk image is malformed
   Ã— Wallet Ledger Integration > should handle the one-time welcome grant 77ms
     â†’ database disk image is malformed

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 8 â¯â¯â¯â¯â¯â¯â¯

 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should start with 100 credits (from daily grant)
 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should prevent double-granting during concurrent requests (Race Condition)
 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should prevent negative balance during concurrent consumption
SqliteError: database disk image is malformed
 â¯ SqliteConnection.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/dialect/sqlite/sqlite-driver.js:65:28
 â¯ node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:35:45
 â¯ SingleConnectionProvider.#run node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:24:22
 â¯ SingleConnectionProvider.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:16:41
 â¯ DefaultQueryExecutor.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/default-query-executor.js:20:41
 â¯ DefaultQueryExecutor.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:34:27
 â¯ SelectQueryBuilderImpl.execute node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-builder/select-query-builder.js:317:51
 â¯ SelectQueryBuilderImpl.executeTakeFirst node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-builder/select-query-builder.js:321:37
 â¯ stzUser/lib/wallet.logic.ts:46:8
     44|       .where('type', '=', 'daily_grant')
     45|       .where('created_at', '>=', today)
     46|       .executeTakeFirst()
       |        ^
     47| 
     48|     if (!existingGrant) {
 â¯ node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/kysely.js:569:38

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/8]â¯

 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should consume resources from daily grant
 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should consume from credits after grant is exhausted
SqliteError: database disk image is malformed
 â¯ SqliteConnection.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/dialect/sqlite/sqlite-driver.js:68:51
 â¯ node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:35:45
 â¯ SingleConnectionProvider.#run node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:24:22
 â¯ SingleConnectionProvider.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:16:41
 â¯ DefaultQueryExecutor.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/default-query-executor.js:20:41
 â¯ DefaultQueryExecutor.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:34:27
 â¯ InsertQueryBuilder.execute node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-builder/insert-query-builder.js:1106:51
 â¯ stzUser/lib/wallet.logic.ts:91:12
     89|             created_at: new Date().toISOString(),
     90|           })
     91|           .execute()
       |            ^
     92|         return true
     93|       }
 â¯ node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/kysely.js:569:32

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/8]â¯

 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should handle granting credits correctly
 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should support consuming multiple credits at once
SqliteError: database disk image is malformed
 â¯ SqliteConnection.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/dialect/sqlite/sqlite-driver.js:68:51
 â¯ node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:35:45
 â¯ SingleConnectionProvider.#run node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:24:22
 â¯ SingleConnectionProvider.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:16:41
 â¯ DefaultQueryExecutor.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/default-query-executor.js:20:41
 â¯ DefaultQueryExecutor.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:34:27
 â¯ InsertQueryBuilder.execute node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-builder/insert-query-builder.js:1106:51
 â¯ grantCreditsTx stzUser/lib/wallet.logic.ts:141:6
    139|       created_at: new Date().toISOString(),
    140|     })
    141|     .execute()
       |      ^
    142| 
    143|   // 2. Update user cached balance
 â¯ stzUser/lib/wallet.logic.ts:116:18
 â¯ node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/kysely.js:569:38

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/8]â¯

 FAIL  stzUser/test/unit/wallet.integration.test.ts > Wallet Ledger Integration > should handle the one-time welcome grant
SqliteError: database disk image is malformed
 â¯ SqliteConnection.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/dialect/sqlite/sqlite-driver.js:68:51
 â¯ node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:35:45
 â¯ SingleConnectionProvider.#run node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:24:22
 â¯ SingleConnectionProvider.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/driver/single-connection-provider.js:16:41
 â¯ DefaultQueryExecutor.provideConnection node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/default-query-executor.js:20:41
 â¯ DefaultQueryExecutor.executeQuery node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-executor/query-executor-base.js:34:27
 â¯ InsertQueryBuilder.execute node_modules/.pnpm/kysely@0.28.5/node_modules/kysely/dist/esm/query-builder/insert-query-builder.js:1106:51
 â¯ grantCreditsTx stzUser/lib/wallet.logic.ts:141:6
    139|       created_at: new Date().toISOString(),
    140|     })
    141|     .execute()
       |      ^
    142| 
    143|   // 2. Update user cached balance
 â¯ stzUser/lib/wallet.logic.ts:197:11

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/8]â¯


 Test Files  1 failed (1)
      Tests  8 failed (8)
   Start at  16:30:03
   Duration  1.76s (transform 257ms, setup 55ms, collect 703ms, tests 764ms, environment 0ms, prepare 58ms)

â€‰ELIFECYCLEâ€‰ Test failed. See above for more details.
